### 集約関数/行数カウント/合計/平均/最大/最小/GROUP/HAVING/ORDER BY

#### Rules
- COUNT関数は引数によって動作が異なる
  - COUNT(*)はNULLを含む行数を数える
  - COUNT(<列名>)はNULLを除外した行数を数える
- 集約関数で計算する場合、NULLがあれば除外して計算する
- MAX/MIN関数はほとんど全てのデータ型に適用できる
- SUM/AVG関数は数値のみにしか適用できない

- 句の順番(暫定)
 → 1.SELECT -> 2.FROM -> 3.WHERE -> 4.GROUP BY

- 集約キー/グループ化列 : GROUP BY句に指定する列のことを集約キー、グループ化列と呼ぶ
- WHERE句とGROUP BYを併用した場合はWHERE句で絞った結果に対してGROUP BYが使われる
- 集約関数を使えるのはSELECT句/HAVING句だけ

(よくある間違い!!)

1. SELECT句には定数, 集約関数(COUNT,MAXなど),GROUP BYで指定した列名(つまり集約キー)しか書けない

2. GROUP BY句でASを用いて別名にした列の名前を使うことはできない

3. GROUP BYを使って複数行の結果を出した時の表示はランダム表示になる

4. WHERE句に集約関数は書けない


#### KYEWORD
- COUNT
  - テーブルの行数をカウント
- SUM
  - テーブルの数値列のデータを合計 
- AVG
  - テーブルの数値列のデータを平均
- MAX
  - テーブルの任意の列のデータの最大値を求める 
- MIN
  -   - テーブルの任意の列のデータの最小値を求める  
  

##### テーブル
```
mysql> select * FROM Shohin;
+-----------+-----------------------+--------------------+--------------+--------------+------------+
| shohin_id | shohin_mei            | shohin_bunrui      | hanbai_tanka | shiire_tanka | torokubi   |
+-----------+-----------------------+--------------------+--------------+--------------+------------+
| 0001      | Tシャツ               | 衣服               |         1000 |          500 | 2009-09-20 |
| 0002      | 穴あけパンチ          | 事務用品           |          500 |          320 | 2009-09-11 |
| 0003      | カッターシャツ        | 衣服               |         4000 |         2800 | NULL       |
| 0004      | 包丁                  | キッチン用品       |         3000 |         2800 | 2009-09-20 |
| 0005      | 圧力鍋                | キッチン用品       |         6800 |         5000 | 2009-01-15 |
| 0006      | フォーク              | キッチン用品       |          500 |         NULL | 2009-09-20 |
| 0007      | おろしがね            | キッチン用品       |          880 |          790 | 2008-04-28 |
| 0008      | ボールペン            | 事務用品           |          100 |         NULL | 2009-11-11 |
+-----------+-----------------------+--------------------+--------------+--------------+------------+
```


#### COUNT
- テーブルの全行数を数える
```
mysql> SELECT COUNT(*) 
  FROM Shohin;

+----------+
| COUNT(*) |
+----------+
|        8 |
+----------+
```

- テーブルのNULLを除外して行数を数える
```
mysql> SELECT COUNT(shiire_tanka) 
  FROM Shohin;

+---------------------+
| COUNT(shiire_tanka) |
+---------------------+
|                   6 |
+---------------------+
```

- 合計を求める(1つの列)
```
mysql> SELECT SUM(hanbai_tanka) 
  FROM Shohin;
+-------------------+
| SUM(hanbai_tanka) |
+-------------------+
|             16780 |
+-------------------+
```

- 合計を求める(2つの列の場合)
```
mysql> SELECT SUM(hanbai_tanka), SUM(shiire_tanka) 
  FROM Shohin;
+-------------------+-------------------+
| SUM(hanbai_tanka) | SUM(shiire_tanka) |
+-------------------+-------------------+
|             16780 |             12210 |
+-------------------+-------------------+
```

- 平均を求める
```
mysql> SELECT AVG(hanbai_tanka) 
  FROM Shohin;

+-------------------+
| AVG(hanbai_tanka) |
+-------------------+
|         2097.5000 |
+-------------------+
```

- 平均を求める(2つの列の場合)
```
mysql> SELECT AVG(hanbai_tanka), AVG(shiire_tanka) 
  FROM Shohin;

+-------------------+-------------------+
| AVG(hanbai_tanka) | AVG(shiire_tanka) |
+-------------------+-------------------+
|         2097.5000 |         2035.0000 |
+-------------------+-------------------+
```

- 最大値と最小値を求める
```
mysql> SELECT MAX(hanbai_tanka), MIN(shiire_tanka) 
  FROM Shohin;

+-------------------+-------------------+
| MAX(hanbai_tanka) | MIN(shiire_tanka) |
+-------------------+-------------------+
|              6800 |               320 |
+-------------------+-------------------+
```

- 日付の最大値と最小値を求めることができる
```
mysql> SELECT MAX(torokubi), MIN(torokubi) 
  FROM Shohin;
+---------------+---------------+
| MAX(torokubi) | MIN(torokubi) |
+---------------+---------------+
| 2009-11-11    | 2008-04-28    |
+---------------+---------------+
```

- 重複を除外して行数をカウント(重複を除外してからカウントされるので結果:3)
```
mysql> SELECT COUNT(DISTINCT shohin_bunrui) 
  FROM Shohin;

+-------------------------------+
| COUNT(DISTINCT shohin_bunrui) |
+-------------------------------+
|                             3 |
+-------------------------------+
```

  -　(注意:良くない例)数を数えてから重複をカウントになるので結果:8
```
mysql> SELECT DISTINCT COUNT(shohin_bunrui) 
  FROM Shohin;
+----------------------+
| COUNT(shohin_bunrui) |
+----------------------+
|                    8 |
+----------------------+
```

- 最初は重複なしで合計、２つ目は重複を除外して合計
```
mysql> SELECT SUM(hanbai_tanka), SUM(DISTINCT hanbai_tanka) 
  FROM Shohin;
+-------------------+----------------------------+
| SUM(hanbai_tanka) | SUM(DISTINCT hanbai_tanka) |
+-------------------+----------------------------+
|             16780 |                      16280 |
+-------------------+----------------------------+
```

#### テーブルをグループに切り分ける
 → (例) 商品ごと、登録日こととか

- 商品分類ごとの個数を調べる
```
mysql> SELECT shohin_bunrui, COUNT(*)
    ->   FROM Shohin;
+---------------+----------+
| shohin_bunrui | COUNT(*) |
+---------------+----------+
| 衣服          |        8 |
+---------------+----------+
```


```
mysql> SELECT shohin_bunrui, COUNT(*) 
  FROM Shohin
 GROUP BY shohin_bunrui;
+--------------------+----------+
| shohin_bunrui      | COUNT(*) |
+--------------------+----------+
| キッチン用品       |        4 |
| 事務用品           |        2 |
| 衣服               |        2 |
+--------------------+----------+
```

- 仕入れ単価ごとに行数を調べる
```
mysql> SELECT shiire_tanka, COUNT(*) 
  FROM Shohin 
 GROUP BY shiire_tanka;

+--------------+----------+
| shiire_tanka | COUNT(*) |
+--------------+----------+
|         NULL |        2 |
|          320 |        1 |
|          500 |        1 |
|          790 |        1 |
|         2800 |        2 |
|         5000 |        1 |
+--------------+----------+
```

- WHERE句で絞ってGROUP BYをする
```
mysql> SELECT shiire_tanka, COUNT(*) 
  FROM Shohin WHERE torokubi = '2009-09-20'
 GROUP BY shiire_tanka;

+--------------+----------+
| shiire_tanka | COUNT(*) |
+--------------+----------+
|         NULL |        1 |
|          500 |        1 |
|         2800 |        1 |
+--------------+----------+
```

#### 集約した結果に条件を指定する(HAVING句)
- GROUP BYで集約したその集合体に対して条件をしてする句
- GROUP BY句の後ろにHAVING句を書く
  - → (SELECT) -> (FROM) -> (WHERE) -> (GROUP BY) -> (HAVING) 

- HAVING句は、定数,集約関数, GROUP BY句で指定した列名が使える
  - GROUP BY句で絞った列名以外には適用できない

- (大事) WHERE句/HAVING句のどちらに条件式を書くべきか?
  - WHERE句 : 行に対する条件指定
  - HAVING句: グループに対する条件指定
  - 実行速度 : WHERE句 >>> HAVING句
    -　WHERE句の方が処理が速い 


- GROUP BY句で商品分類をしてカウントしその結果に対して行数が2のものに絞る
```
mysql> SELECT shohin_bunrui, COUNT(*) 
  FROM Shohin 
 GROUP BY shohin_bunrui 
HAVING COUNT(*) = 2;

+---------------+----------+
| shohin_bunrui | COUNT(*) |
+---------------+----------+
| 事務用品      |        2 |
| 衣服          |        2 |
+---------------+----------+
````

- GROUP BY句で商品分類した単価の平均に対してその平均値が2500以上のものに絞る
```
mysql> SELECT shohin_bunrui, AVG(hanbai_tanka) 
  FROM Shohin 
 GROUP BY shohin_bunrui 
HAVING AVG(hanbai_tanka) >= 2500;

+--------------------+-------------------+
| shohin_bunrui      | AVG(hanbai_tanka) |
+--------------------+-------------------+
| キッチン用品       |         2795.0000 |
| 衣服               |         2500.0000 |
+--------------------+-------------------+
```

#### ORDER BY句
- ORDER BY句はSELECT文の最後に書く
- ORDER BY句で何も指定しなければ昇順になる
- NULLを含むソートはまとめて最初か最後に表示される
- ORDER BY句ではASを使った列の別名が使える


- 昇順に並べる(hanbai_tanka)
```
mysql> SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka 
  FROM Shohin 
 ORDER BY hanbai_tanka;

+-----------+-----------------------+--------------+--------------+
| shohin_id | shohin_mei            | hanbai_tanka | shiire_tanka |
+-----------+-----------------------+--------------+--------------+
| 0008      | ボールペン            |          100 |         NULL |
| 0002      | 穴あけパンチ          |          500 |          320 |
| 0006      | フォーク              |          500 |         NULL |
| 0007      | おろしがね            |          880 |          790 |
| 0001      | Tシャツ               |         1000 |          500 |
| 0004      | 包丁                  |         3000 |         2800 |
| 0003      | カッターシャツ        |         4000 |         2800 |
| 0005      | 圧力鍋                |         6800 |         5000 |
+-----------+-----------------------+--------------+--------------+
```

- 降順に並べる(hanbai_tanka) -> DESCをつける
```
mysql> SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka
    ->   FROM Shohin
    ->  ORDER BY hanbai_tanka DESC;
+-----------+-----------------------+--------------+--------------+
| shohin_id | shohin_mei            | hanbai_tanka | shiire_tanka |
+-----------+-----------------------+--------------+--------------+
| 0005      | 圧力鍋                |         6800 |         5000 |
| 0003      | カッターシャツ        |         4000 |         2800 |
| 0004      | 包丁                  |         3000 |         2800 |
| 0001      | Tシャツ               |         1000 |          500 |
| 0007      | おろしがね            |          880 |          790 |
| 0002      | 穴あけパンチ          |          500 |          320 |
| 0006      | フォーク              |          500 |         NULL |
| 0008      | ボールペン            |          100 |         NULL |
+-----------+-----------------------+--------------+--------------+
```

- 販売単価と商品IDを昇順に並べる
 -> 販売単価が同じ時はIDの昇順にする
```
mysql> SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka FROM Shohin ORDER BY hanbai_tanka, shohin_id;
+-----------+-----------------------+--------------+--------------+
| shohin_id | shohin_mei            | hanbai_tanka | shiire_tanka |
+-----------+-----------------------+--------------+--------------+
| 0008      | ボールペン            |          100 |         NULL |
| 0002      | 穴あけパンチ          |          500 |          320 |
| 0006      | フォーク              |          500 |         NULL |
| 0007      | おろしがね            |          880 |          790 |
| 0001      | Tシャツ               |         1000 |          500 |
| 0004      | 包丁                  |         3000 |         2800 |
| 0003      | カッターシャツ        |         4000 |         2800 |
| 0005      | 圧力鍋                |         6800 |         5000 |
+-----------+-----------------------+--------------+--------------+
```

- 販売単価と商品IDを別名にしてソート
```
mysql> SELECT shohin_id AS id, shohin_mei, hanbai_tanka AS ht, shiire_tanka
  FROM Shohin 
 ORDER BY ht,id;
 
+------+-----------------------+------+--------------+
| id   | shohin_mei            | ht   | shiire_tanka |
+------+-----------------------+------+--------------+
| 0008 | ボールペン            |  100 |         NULL |
| 0002 | 穴あけパンチ          |  500 |          320 |
| 0006 | フォーク              |  500 |         NULL |
| 0007 | おろしがね            |  880 |          790 |
| 0001 | Tシャツ               | 1000 |          500 |
| 0004 | 包丁                  | 3000 |         2800 |
| 0003 | カッターシャツ        | 4000 |         2800 |
| 0005 | 圧力鍋                | 6800 |         5000 |
+------+-----------------------+------+--------------+
```

- 列名指定でソート
```
mysql> SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka 
  FROM Shohin
 ORDER BY hanbai_tanka DESC, shohin_id;
```

- 列番号指定でソート(将来なくなる機能,ややこしいので使うのをやめよう)
```
mysql> SELECT shohin_id, shohin_mei, hanbai_tanka, shiire_tanka 
  FROM Shohin
 ORDER BY 3 DESC, 1;


<結果は共通>
+-----------+-----------------------+--------------+--------------+
| shohin_id | shohin_mei            | hanbai_tanka | shiire_tanka |
+-----------+-----------------------+--------------+--------------+
| 0005      | 圧力鍋                |         6800 |         5000 |
| 0003      | カッターシャツ        |         4000 |         2800 |
| 0004      | 包丁                  |         3000 |         2800 |
| 0001      | Tシャツ               |         1000 |          500 |
| 0007      | おろしがね            |          880 |          790 |
| 0002      | 穴あけパンチ          |          500 |          320 |
| 0006      | フォーク              |          500 |         NULL |
| 0008      | ボールペン            |          100 |         NULL |
+-----------+-----------------------+--------------+--------------+
```


- テーブルデータを加工して他のテーブルにコピーする
```
mysql> INSERT INTO ShohinBunrui (shohin_bunrui, sum_hanbai_tanka, sum_shiire_tanka)
  SELECT shohin_bunrui, SUM(hanbai_tanka), SUM(shiire_tanka) FROM Shohin GROUP BY shohin_bunrui;


mysql> SELECT * FROM ShohinBunrui;                                                                          +--------------------+------------------+------------------+
| shohin_bunrui      | sum_hanbai_tanka | sum_shiire_tanka |
+--------------------+------------------+------------------+
| キッチン用品       |            11180 |             8590 |
| 事務用品           |              600 |              320 |
| 衣服               |             5000 |             3300 |
+--------------------+------------------+------------------+
```
